# エクスポート/インポート機能レビュー

このドキュメントは、WeeklySignalアプリケーションにおけるエクスポートおよびインポート機能の現在の実装に関するレビューを提供します。

## 1. アーキテクチャの概要

エクスポート/インポート機能は、懸念事項を効果的に分離する堅牢なマルチプラットフォームアーキテクチャに基づいて構築されています。

-   **UI層**: Composableスクリーン（`ExportImportScreen`、`ExportSelectionScreen`、`ImportSelectionScreen`）は、UIのレンダリングとユーザー入力の取得を担当します。
-   **ViewModel層**: `WeeklySignalViewModel`は、状態ホルダーとして機能し、エクスポート/インポートフローのロジックを処理します。
-   **サービス層**: `ExportImportService`は、`SignalItem`データをJSON形式に変換するコアビジネスロジックを含みます。
-   **プラットフォーム固有層**: `FileOperationsService`インターフェースは、ファイルシステムとの相互作用を抽象化し、Android（`AndroidFileOperationsService`）およびデスクトップ（`DesktopFileOperationsService`）用の具体的な実装を提供します。

この分離により、コードベースはクリーンで保守しやすく、スケーラブルになります。

## 2. データフロー

### エクスポートフロー

1.  ユーザーは`ExportImportScreen`に移動し、エクスポートプロセスを開始して`ExportSelectionScreen`に遷移します。
2.  ユーザーは、エクスポートするシグナルアイテムや特定のタイムスロットを選択します。この選択は`WeeklySignalViewModel`でキャプチャされます。
3.  確認後、`ExportImportScreen`はエクスポートロジックをトリガーします。
4.  `ExportImportService`は、選択されたデータを構造化されたJSON形式にシリアル化します。
5.  適切な`FileOperationsService`の実装が、JSONデータをデバイス上の`.weeklysignal`ファイルに書き込みます。

### インポートフロー

1.  ユーザーは「ファイルからインポート」を選択し、プラットフォーム固有のファイルピッカーを使用して`.weeklysignal`ファイルを選択します。
2.  `FileOperationsService`はファイルの内容を読み取ります。
3.  `ExportImportService`はJSONをパースし、`SignalItem`オブジェクトのリストにデシリアル化します。
4.  アプリは`ImportSelectionScreen`に移動し、ユーザーはパースされたアイテムを確認し、インポートするものを選択できます。
5.  確認後、`WeeklySignalViewModel`は選択された`SignalItem`をデータベースに保存します。

## 3. 強み

-   **クリーンな関心の分離**: アーキテクチャは、UI、状態管理、ビジネスロジック、プラットフォーム固有のコードを明確に分離しています。
-   **選択的な操作**: ユーザーがエクスポートおよびインポートするものを正確に選択できる機能は、優れた柔軟性を提供します。
-   **優れたプラットフォーム抽象化**: `FileOperationsService`インターフェースは、KMPプロジェクトにおけるプラットフォーム固有の詳細を抽象化する好例です。
-   **モダンな状態管理**: ViewModelでの`StateFlow`とUIでの`collectAsStateWithLifecycle`の使用は、最新のベストプラクティスに従っています。
-   **人間が読めるデータ形式**: JSONはエクスポート形式として良い選択であり、機械で解析可能であると同時に人間が読める形式です。メタデータの含まれている点もプラスです。

## 4. 改善点

-   **トランザクションによるインポート**: 現在のインポートプロセスでは、アイテムが1つずつデータベースに追加されます。途中でエラーが発生した場合、データベースが不整合な、部分的にインポートされた状態になる可能性があります。
    -   **推奨事項**: トランザクションによるインポートメカニズムを実装します。`SignalRepository`に`addSignalItems(items: List<SignalItem>)`のような新しいメソッドを追加することで、インポート全体を単一のデータベーストランザクション内で実行し、原子性を確保できます。

-   **インポート時の競合解決**: アプリケーションには現在、インポート時の競合を処理する戦略がありません。データベースに一致するUUIDを持つアイテムが既に存在する場合、どのような動作になるかは明確ではありません。UIテキストには競合の処理について言及されていますが、ロジックはまだ実装されていません。
    -   **推奨事項**: インポートする前に競合（例: UUIDに基づく）を検出します。`ImportSelectionScreen`で競合するアイテムにフラグを立て、ユーザーに**上書き**、**スキップ**、または**両方を保持**などのアクションを選択できるようにします。

-   **ViewModelの責務**: `WeeklySignalViewModel`は、週表示、アイテム登録、およびエクスポート/インポートフロー全体をカバーするなど、多くの責務を蓄積しています。
    -   **推奨事項**: エクスポート/インポートロジックと状態を専用の`ExportImportViewModel`にリファクタリングします。これにより、関心の分離が改善され、`WeeklySignalViewModel`の複雑さが軽減され、コードの管理が容易になります。

-   **ハードコードされた文字列**: 多くのユーザー向け文字列（ダイアログメッセージ、ボタンラベル、説明テキスト）がComposable関数に直接ハードコードされています。
    -   **推奨事項**: すべてのユーザー向け文字列を共通のリソースファイル（例: Composeの組み込みリソース管理を使用）に外部化します。これは、将来のローカライズ作業にとって非常に重要であり、保守性を向上させます。
